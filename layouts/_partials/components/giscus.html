{{- $lang := site.Language.Lang | default `en` -}}
{{- if hasPrefix $lang "zh" -}}
  {{- /* See: https://github.com/giscus/giscus/tree/main/locales */}}
  {{- $lang = site.Language.LanguageCode | default `zh-CN` -}}
{{- end -}}

{{- with site.Params.comments.giscus -}}
<script>
  function getGiscusTheme() {
    const giscusTheme = '{{ .theme }}';
    if (giscusTheme === 'light' || giscusTheme === 'dark') {
      return giscusTheme;
    }

    const hugoTheme = localStorage.getItem("color-theme");
    if (hugoTheme === 'light' || hugoTheme === 'dark') {
      return hugoTheme;
    }

    if (hugoTheme === 'system') {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    const defaultTheme = '{{ site.Params.theme.default }}';
    if (defaultTheme === 'light' || defaultTheme === 'dark') {
      return defaultTheme;
    }

    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function setGiscusTheme() {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;

    const msg = {
      giscus: {
        setConfig: {
          theme: getGiscusTheme(),
        },
      },
    }

    iframe.contentWindow.postMessage(msg, 'https://giscus.app');
  }

  document.addEventListener('DOMContentLoaded', function () {
    const giscusAttributes = {
      "src": "https://giscus.app/client.js",
      "data-repo": "{{ .repo }}",
      "data-repo-id": "{{ .repoId }}",
      "data-category": "{{ .category }}",
      "data-category-id": "{{ .categoryId }}",
      "data-mapping": "{{ .mapping | default `pathname` }}",
      "data-strict": "{{ (string .strict) | default 0 }}",
      "data-reactions-enabled": "{{ (string .reactionsEnabled) |  default 1 }}",
      "data-emit-metadata": "{{ (string .emitMetadata) | default 0 }}",
      "data-input-position": "{{ .inputPosition | default `top` }}",
      "data-theme": getGiscusTheme(),
      "data-lang": "{{ .lang | default $lang }}",
      "crossorigin": "anonymous",
      "data-loading": "lazy",
      "async": "",
    };

    // Dynamically create script tag
    const giscusScript = document.createElement("script");
    Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
    // Random hash id to avoid conflicts with titles inside pages.
    document.getElementById('giscus-hextra-bb112b9f807c37c1752e5da6a1652a29').appendChild(giscusScript);

    // Listen for system theme changes
    window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", setGiscusTheme);

    // Update giscus theme when theme switcher is clicked
    const themeToggleOptions = document.querySelectorAll(".hextra-theme-toggle-options p");
    if (themeToggleOptions) {
      themeToggleOptions.forEach(toggle => toggle.addEventListener('click', setGiscusTheme));
    }
  });
</script>

<details class="hx:last-of-type:mb-0 hx:rounded-lg hx:bg-neutral-50 hx:dark:bg-neutral-800 hx:p-2 hx:mt-4 hx:group" >
  <summary class="hx:flex hx:items-center hx:cursor-pointer hx:select-none hx:list-none hx:p-1 hx:rounded-sm hx:transition-colors hx:hover:bg-gray-100 hx:dark:hover:bg-neutral-800 hx:before:mr-1 hx:before:inline-block hx:before:transition-transform hx:before:content-[''] hx:dark:before:invert hx:rtl:before:rotate-180 hx:group-open:before:rotate-90">
    <strong class="hx:text-lg">Discussions</strong>
  </summary>
  <div class="hx:p-2 hx:overflow-hidden">
    <div id="giscus-hextra-bb112b9f807c37c1752e5da6a1652a29"></div>
</details>
{{- else -}}
  {{ warnf "giscus is not configured" }}
{{- end -}}
